<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quét QR CCCD Gắn Chip</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f6;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        h2 {
            text-align: center;
            color: #0056b3;
            margin-bottom: 20px;
        }

        #reader {
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
            margin-bottom: 20px;
        }

        /* Form hiển thị thông tin */
        .info-group {
            display: none; /* Ẩn khi chưa quét */
            animation: fadeIn 0.5s;
        }

        .form-row {
            margin-bottom: 15px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }

        .label {
            font-weight: bold;
            color: #555;
            font-size: 0.9rem;
            display: block;
            margin-bottom: 4px;
        }

        .value {
            color: #222;
            font-size: 1.1rem;
            word-wrap: break-word;
        }

        .alert-error {
            color: red;
            text-align: center;
            display: none;
            margin-top: 10px;
        }

        .btn-reset {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #0056b3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Scanner CCCD Gắn Chip</h2>
        
        <div id="reader"></div>
        <div id="error-msg" class="alert-error">Mã QR không hợp lệ hoặc không phải CCCD!</div>

        <div id="result-area" class="info-group">
            <div class="form-row">
                <span class="label">Số CCCD:</span>
                <span class="value" id="cccd_no"></span>
            </div>
            <div class="form-row">
                <span class="label">Số CMND cũ:</span>
                <span class="value" id="cmnd_no"></span>
            </div>
            <div class="form-row">
                <span class="label">Họ và tên:</span>
                <span class="value" id="full_name" style="color: #d32f2f; font-weight: bold;"></span>
            </div>
            <div class="form-row">
                <span class="label">Ngày sinh:</span>
                <span class="value" id="dob"></span>
            </div>
            <div class="form-row">
                <span class="label">Giới tính:</span>
                <span class="value" id="gender"></span>
            </div>
            <div class="form-row">
                <span class="label">Địa chỉ thường trú:</span>
                <span class="value" id="address"></span>
            </div>
            <div class="form-row">
                <span class="label">Ngày cấp:</span>
                <span class="value" id="issue_date"></span>
            </div>

            <button class="btn-reset" onclick="resetScanner()">Quét lại</button>
        </div>
    </div>

    <script>
        let html5QrcodeScanner;

        function onScanSuccess(decodedText, decodedResult) {
            // Kiểm tra định dạng CCCD (phải chứa ký tự '|')
            if (!decodedText.includes('|')) {
                document.getElementById('error-msg').style.display = 'block';
                return;
            }

            document.getElementById('error-msg').style.display = 'none';

            // Tách chuỗi dữ liệu
            // Cấu trúc: 0:CCCD | 1:CMND | 2:Tên | 3:NgàySinh | 4:GiớiTinh | 5:ĐịaChỉ | 6:NgàyCấp
            const data = decodedText.split('|');

            // Điền dữ liệu vào form (Kiểm tra độ dài mảng để tránh lỗi)
            if (data.length >= 6) {
                // Tạm dừng camera sau khi quét thành công
                html5QrcodeScanner.pause(); 

                document.getElementById('cccd_no').innerText = data[0] || 'N/A';
                document.getElementById('cmnd_no').innerText = data[1] || 'Không có';
                document.getElementById('full_name').innerText = data[2] || 'N/A';
                
                // Xử lý ngày sinh (đôi khi format là 01011990 hoặc 01/01/1990)
                document.getElementById('dob').innerText = formatDate(data[3]);
                
                document.getElementById('gender').innerText = data[4] || 'N/A';
                document.getElementById('address').innerText = data[5] || 'N/A';
                document.getElementById('issue_date').innerText = formatDate(data[6]);

                // Hiển thị vùng kết quả, ẩn camera (tùy chọn)
                document.getElementById('result-area').style.display = 'block';
                document.querySelector('.btn-reset').style.display = 'block';
            }
        }

        // Hàm định dạng lại ngày tháng cho đẹp (nếu cần)
        function formatDate(dateStr) {
            if (!dateStr) return '';
            // Nếu chuỗi là 8 số liền nhau (ví dụ 20051990), có thể cần format lại
            // Nhưng CCCD thường trả về dd/mm/yyyy sẵn rồi.
            return dateStr;
        }

        function onScanFailure(error) {
            // Không làm gì để tránh spam console
        }

        // Hàm reset để quét người tiếp theo
        function resetScanner() {
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('cccd_no').innerText = '';
            // Tiếp tục camera
            html5QrcodeScanner.resume();
        }

        // Khởi tạo Scanner
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", 
            { 
                fps: 10, 
                qrbox: { width: 300, height: 300 }, // Tăng kích thước vùng quét cho CCCD
                aspectRatio: 1.0
            },
            false
        );

        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    </script>
</body>
</html>